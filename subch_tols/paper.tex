\documentclass[linenumbers,trackchanges]{aastex631}

%\usepackage{xcolor,amsmath}

\usepackage[T1]{fontenc}

\newcommand{\sfrac}[2]{\mathchoice%
  {\kern0em\raise.5ex\hbox{\the\scriptfont0 #1}\kern-.15em/
    \kern-.15em\lower.25ex\hbox{\the\scriptfont0 #2}}
  {\kern0em\raise.5ex\hbox{\the\scriptfont0 #1}\kern-.15em/
    \kern-.15em\lower.25ex\hbox{\the\scriptfont0 #2}}
  {\kern0em\raise.5ex\hbox{\the\scriptscriptfont0 #1}\kern-.2em/
    \kern-.15em\lower.25ex\hbox{\the\scriptscriptfont0 #2}} {#1\!/#2}}

\newcommand{\myhalf}{\sfrac{1}{2}}
\newcommand{\nph}{{n+\myhalf}}
\newcommand{\nmh}{{n-\myhalf}}

\newcommand{\inp}{\mathrm{in}}
\newcommand{\outp}{\mathrm{out}}

% boldsymbol means bold italic
\newcommand{\eb}{{\bf{e}}}
\newcommand{\Ub}{{\bf{U}}}
\newcommand{\xb}{{\bf{x}}}
\newcommand{\kb}{{\bf{k}}}
\newcommand{\Vb}{{\bf{V}}_n}
\newcommand{\Vbhat}{{\bf{\widehat{V}}}_n}
\newcommand{\Omegab}{{\bf{\Omega}}}
\newcommand{\gb}{{\bf{g}}}
\newcommand{\rb}{{\bf{r}}}

\newcommand{\pb}{p_\mathrm{base}}
\newcommand{\epsdot}{\dot{\epsilon}}
\newcommand{\qburn}{q_\mathrm{burn}}
\newcommand{\rt}{\tilde{r}_0}


\newcommand{\nablab}{\mathbf{\nabla}}
\newcommand{\dt}{\Delta\ t}

\newcommand{\omegadot}{\dot{\omega}}

\newcommand{\Hext}{H_{\rm ext}}
\newcommand{\Hnuc}{H_{\rm nuc}}
\newcommand{\kth}{k_{\rm th}}

\newcommand{\Gammaonebar}{\overline{\Gamma}_1}
\newcommand{\Sbar}{\overline{S}}

\newcommand{\etarho}{\eta_\rho}
\newcommand{\etarhoh}{\eta_{\rho~h}}

\newcommand{\Ubt}{\widetilde{\Ub}}
\newcommand{\wt}{\widetilde{w}}

\newcommand{\He}{$^4$He}
\newcommand{\C}{$^{12}$C}
\newcommand{\Fe}{$^{56}$Fe}

\newcommand{\isot}[2]{$^{#2}\mathrm{#1}$}
\newcommand{\isotm}[2]{{}^{#2}\mathrm{#1}}

\newcommand{\maestro}{{\sf MAESTRO}}
\newcommand{\castro}{{\sf Castro}}
\newcommand{\amrex}{{\sf AMReX}}
\newcommand{\pynucastro}{{\sf pynucastro}}

\newcommand{\avg}[1]{\overline{#1}}
\newcommand{\avgtwod}[1]{\langle~#1 \rangle}
\newcommand{\rms}[2]{\left(\delta#1\right)_{r_{#2}}}
\newcommand{\mymax}[1]{\left(#1\right)_{\rm max}}

\newcommand{\Tb}{\ensuremath{T_\mathrm{base}}}
\newcommand{\gcc}{\mathrm{g~cm^{-3} }}
\newcommand{\cms}{\mathrm{cm~s^{-1} }}

\newcommand{\half}{\frac{1}{2}}


\newcommand{\ddx}[1]{{\frac{{\partial#1}}{\partial x}}}
\newcommand{\ddxs}[1]{{\frac{{\partial}}{\partial x}}#1}
\newcommand{\ddt}[1]{{\frac{{\partial#1}}{\partial t}}}
\newcommand{\odt}[1]{{\frac{{d#1}}{dt}}}
\newcommand{\divg}[1]{{\nablab \cdot \left (#1\right)}}
\newcommand{\dedr}{\left . {\partial{}e}/{\partial\rho}\right |_{T, X_k}}
\newcommand{\dedrd}{\left . \frac{\partial{}e}{\partial\rho}\right |_{T, X_k}}
\newcommand{\dedX}{\left . {\partial{}e}/{\partial{}X_k} \right |_{\rho, T}}
\newcommand{\dedXd}{\left . \frac{\partial{}e}{\partial{}X_k} \right |_{\rho, T, X_{j,j\ne k}}}
\newcommand{\dedT}{\left . {\partial{}e}/{\partial{}T} \right |_{\rho,X_k}}
\newcommand{\dedTd}{\left . \frac{\partial{}e}{\partial{}T} \right |_{\rho,X_k}}

\newcommand{\Ic}{{\boldsymbol{\mathcal{I}}}}
\newcommand{\Ics}{{\mathcal{I}}}
\newcommand{\kmax}{{k_\mathrm{max}}}
\usepackage{bm}

\newcommand{\Uc}{{\,\bm{\mathcal{U}}}}
\newcommand{\Fb}{\mathbf{F}}
\newcommand{\Sc}{\mathbf{S}}

\newcommand{\xv}{{(x)}}
\newcommand{\yv}{{(y)}}
\newcommand{\zv}{{(z)}}

\newcommand{\ex}{{\bf e}_x}
\newcommand{\ey}{{\bf e}_y}
\newcommand{\ez}{{\bf e}_z}

\newcommand{\Ab}{{\bf A}}
\newcommand{\Sq}{{\bf S}_\qb}
\newcommand{\Sqhydro}{{\Sq^{\mathrm{hydro}}}}
\newcommand{\qb}{{\bf q}}

\newcommand{\Gb}{{\bf G}}
\newcommand{\Rb}{{\bf R}}
\newcommand{\Rq}{{\bf R}}
\newcommand{\Adv}[1]{{\left [\boldsymbol{\mathcal{A}} \left(#1\right)\right]}}
\newcommand{\Advt}[1]{{\left [\boldsymbol{\mathcal{\tilde{A}}} \left(#1\right)\right]}}
\newcommand{\Advss}[1]{{\left [{\mathcal{{A}}} \left(#1\right)\right]}}
\newcommand{\Advsst}[1]{{\left [{\mathcal{\tilde{A}}} \left(#1\right)\right]}}
\newcommand{\Advs}[1]{\boldsymbol{\mathcal{A}} \left(#1\right)}



\setlength{\marginparwidth}{0.5in}

\newcommand{\MarginPar}[1]{
    \marginpar{\vskip-\baselineskip%
               \raggedright%
               \tiny\sffamily%
               {\color{red}\hrule%
               \smallskip%
               #1\par%
               \smallskip%
               \hrule}}%
}

\newcommand{\AssignTo}[1]{
    \marginpar{\vskip-\baselineskip%
               \raggedright%
               \tiny\sffamily%
               {\color{blue}\hrule%
               \smallskip%
               #1\par%
               \smallskip%
               \hrule}}%
}

\begin{document}
%======================================================================
% Title
%======================================================================
\title{Influence of Time Integration Methodology on Double Detonation Type
Ia Supernova Nucleosynthesis}

\shorttitle{Integration Methods and SNe Ia Nucleosynthesis}

\author[0000-0001-8401-030X]{Michael Zingale}
\affiliation{Dept.\ of Physics and Astronomy, Stony Brook University,
             Stony Brook, NY 11794-3800, USA}

\author[0000-0002-2839-107X]{Zhi Chen}
\affiliation{Department of Physics and Astronomy,
Stony Brook University,
Stony Brook, NY 11794-3800, USA}


\author[0000-0003-0439-4556]{Max Katz}
\affiliation{Dept.\ of Physics and Astronomy, Stony Brook University,
             Stony Brook, NY 11794-3800, USA}


\author[0000-0001-5961-1680]{Alexander Smith Clark}
\affiliation{Department of Physics and Astronomy,
Stony Brook University,
Stony Brook, NY 11794-3800, USA}

\author[0000-0003-3603-6868]{Eric T. Johnson}
\affiliation{Department of Physics and Astronomy,
Stony Brook University,
Stony Brook, NY 11794-3800, USA}

\correspondingauthor{Michael Zingale}
\email{michael.zingale@stonybrook.edu}


%======================================================================
% Abstract and Keywords
%======================================================================
\begin{abstract}
We explore the early evolution of flame ignition and spreading on the
surface of a neutron star in three-dimensions, in the context of X-ray
bursts.  We look at the nucleosynthesis and morphology of the burning
front and compare to two-dimensional axisymmetric simulations to gauge
how important a full three-dimensional treatment of the flame is for
the early dynamics.  Finally, we discuss the progress toward full-star
resolved flame simulations.\end{abstract}

\keywords{convection---hydrodynamics---methods: numerical---stars: neutron---X-rays: bursts}

%======================================================================
% Introduction
%======================================================================
\section{Introduction}\label{Sec:Introduction}

The double detonation model

Detonations can be difficult to model numerically.  Time step cuts \MarginPar{ref}.
For the double detonation scenario, the ignition of the second detonation
can be very sensitive to how the simulation is run \MarginPar{refs}.
Artifically limiting the rates \MarginPar{ref}

Integration of reaction networks takes various forms in astrophysical
simulation codes.

When using operator-splitting, the density remains constant, since there
is no reaction source in the mass continuity equation.  The mass
fractions, $X_k$, evolve according to:
\begin{equation}
\frac{dX_k}{dt} = \omegadot_k
\end{equation}
where $\omegadot_k$ is the creation rate of species $k$ due to nuclear
reaction.  In the simplest approximation of operator splitting, the
evolution of the mass fractions is solved alone, without integrating
the temperature or energy.  This is the form that was used in FLASH
\cite{flash}.  A more accurate operator splitting also includes the
energy evolution (perhaps in terms of temperature).  This will require
calling the equation of state each time we evaluate the righthand side
of the ODE system, increasing the cost.  However, as we showed in
\citet{strang_rnaas}, this is needed to get second-order convergence.

In \citet{castro_simple_sdc}, we introduced a method based on the
ideas of spectral deferred corrections for coupling reactions and
hydrodyamics (that we called ``simplified-SDC'').  Here, the overall
time-integration is done iteratively, with the hydrodynamics seeing an
explicit reactive source, and the reaction update evolving an ODE
system that includes a piecewise-constant-in-time advective source,
$\Adv{\Uc}^{n+1/2}$,
\begin{equation}
\ddt{\Uc} = \Rb(\Uc) + \Adv{\Uc}^{n+1/2}
\end{equation}

In addition to the time-integration strategy, integrating the reaction
ODE system requires specifying tolerances.  Unfortunately, the tolerances
used are not normally reported in papers, and in many cases, may not
be easily controlled by a code user at runtime.



\citet{castro_simple_sdc} looked at an extreme version of the
double detonation scenario---a very large perturbation was applied
to drive a detonation directly into the underlying
carbon-oxygen white dwarf.  We showed in that paper that the Strang
split integration method had difficulty with the integration unless
we used tighter tolerances

Summary of the SDC subch results form the original paper

%======================================================================
% Results
%======================================================================
\section{Simulations and Results}\label{Sec:results}


We use a 2d axisymmetric domain with a size of $5.12\times 10^9~\mathrm{cm}$ by $1.024\times 10^{10}~\mathrm{cm}$.  This is
much larger than the initial size of the star, giving it plenty of
room to expand.  The coarse grid is $640\times 1280$ zones and we use
2 levels of refinement, giving a maximum resolution of
$20~\mathrm{km}$.  The refinement strategy is picked to refine on the
star and any regions where the temperature is greater than
$10^8~\mathrm{K}$.  \castro\ uses subcycling, so finer grids are
advanced at a smaller timestep than the coarse grids.  Self-gravity is
done using a full Poisson solve using geometric multigrid, with
Dirichlet boundary conditions on the domain boundary computed via a
multipole expansion with a maximum order of 6.  For the low density
regions outside of the star, we use a sponge term on the momentum
equation to prevent the very low density material that is not in
hydrostatic equilibrium from raining down on the star.

All simulations use the same network, a 22 nucleus network designed for
He and C burning, using the ReacLib rates \cite{reaclib} and produced with
\pynucastro \citep{pynucastro2}.  This network, called {\tt subch\_simple} was
described in \cite{zhi2023}.

The reaction system is integrated using a version of the VODE ODE integrator
\citep{vode} ported to C++.  Our modifications to this integrator are described
in \citet{castro_simple_sdc}.

If during the advance of a timestep an error is generated (negative
density, ODE integration fails, mass fractions don't sum to 1), the
step is thrown-out and retied with a smaller timestep.  This is done
on a level-by-level basis in the overall AMR subcycling hierarchy.

We will run a suite of simulations all using the same initial model.
The initial model is constructed following the methodology in
\citet{subchandra}.  We use an isothermal core of C/O of $1.1~M_\odot$
with $T = 10^7~\mathrm{K}$ and a thin transition region where the
temperature ramps up to $1.75\times 10^8~\mathrm{K}$ and the
composition changes to 99\% \isot{He}{4} and 1\% \isot{N}{14}.  This
added \isot{N}{14} helps produce protons via
$\isotm{N}{14}(\alpha,\gamma)\isotm{F}{18}(\alpha,p)\isotm{Ne}{21}$
which then allow for
$\isotm{C}{12}(p,\gamma)\isotm{N}{13}(\alpha,p)\isotm{O}{16}$.  This
sequence can be faster than
$\isotm{C}{12}(\alpha,\gamma)\isotm{O}{16}$, as pointed out by
\citet{shenbildsten} and is important for getting the detonation speed
correctly.  This He envelope is then integrated isentropically.  The
density of the transition from the underlying CO white dwarf to the He
envelope was selected to yield an envelope mass of $0.05~M_\odot$.

We place a small temperature perturbation in the He layer using the
same form as in \citet{castro_simple_sdc}:
\begin{equation}
  T = T_0 \left [ 1 + X(\isotm{He}{4}) f (1 + \tanh(2 - r_1)) \right ]
\end{equation}
where
\begin{equation}
  r_1 = \left [ x^2 + (y - r_0)^2 \right ]^{1/2} / \lambda
\end{equation}
and
\begin{equation}
  r_0 = r_\mathrm{pert} + r_\mathrm{base}
\end{equation}
Here, $r_\mathrm{base}$ is the radius at which the helium layer begins
and $r_\mathrm{pert}$ is the distance above the base to put the
perturbation.  We choose $r_\mathrm{pert} = 100~\mathrm{km}$.  The
temperature is perturbed above the initial model value, denoted as
$T_0$ here.  The amplitude of the perturbation is $f = 3$ and the
scale of the perturbation is $\lambda = 12.5~\mathrm{km}$, and
$r_\mathrm{pert} = 100~\mathrm{km}$.  This is a very small
perturbation, but enough to seed the initial He detonation in the
envelope.



The simulations are all run on the OLCF Frontier machine, using 4
nodes / 32 AMD GPUs.  The data is moved to the GPUs at the start of
the simulation and all computation is done there.  Our GPU offloading
strategy takes advantage of the \amrex\ C++ lambda-capturing
functionality to be performance portable.


We run 3 different types of integration methods: traditional operator
splitting, using Strang splitting, both with integration of the energy
equation and without any temperature evolution during the burn.  \MarginPar{comment about the EOS}.  These methods are compared to the simplified-SDC integtation.

\begin{figure*}[t]
\centering
\plotone{subch_Temp_sequence}
\caption{\label{fig:temp_sequence} Time-sequence of the SDC run showing the temperature.}
\end{figure*}

\begin{figure*}[t]
\centering
\plotone{subch_lap_rho_sequence}
\caption{\label{fig:lap_rho_sequence} Time-sequence of the SDC run showing the compression.}
\end{figure*}


We also vary the CFL number and the integration tolerances.

Show Ni56 mass, intermediate mass

\begin{figure}[t]
\centering
\plotone{subch_ni56}
\caption{\label{fig:ni56} \isot{Ni}{56} mass vs.\ time for the different simulations.}
\end{figure}

\begin{figure}[t]
\centering
\plotone{subch_cpu}
\caption{\label{fig:cpu} MPI-hours of GPU time for the different simulations.}
\end{figure}


Show time-sequence + compression plot

Show cost plot

\section{Summary}

Our results suggest that exploring the time-integration method and
integrator tolerances is an important part of demonstrating
convergence of simulations involving explosive reacting flows in
astrophysics.

The ignition of the carbon detonation remains numerically challenging for the ODE integrator, especially with large timesteps.  \MarginPar{add some info on why it fails}
In the near future we will show how to include various nuclear
statistical equilibrium approximations into the simplified-SDC
formalism while retaining second-order accuracy.

We encourage authors to include a discussion about the reaction integration algorithm
and tolerances in papers to permit comparisons in the future.

\begin{acknowledgements}
\castro\ is open-source and freely available at
\url{http://github.com/AMReX-Astro/Castro}.  The problem setup used
here is available in the git repo as {\tt flame\_wave}. The metadata
describing the build environment and the global diagnostic output
files are available on Zenodo at \citet{xrb_data}.  We thank Alice
Harpole for contributions to the AMReX Astrophysics suite.

The work at Stony Brook was supported by DOE/Office of Nuclear
Physics grant DE-FG02-87ER40317.  This research used resources of the
National Energy Research Scientific Computing Center, a DOE Office of
Science User Facility supported by the Office of Science of the
U.~S.\ Department of Energy under Contract No.\ DE-AC02-05CH11231.
This research was supported by the Exascale Computing Project
(17-SC-20-SC), a collaborative effort of the U.S. Department of Energy
Office of Science and the National Nuclear Security Administration.
This research used resources of the Oak Ridge Leadership Computing
Facility at the Oak Ridge National Laboratory, which is supported by
the Office of Science of the U.S. Department of Energy under Contract
No. DE-AC05-00OR22725, awarded through the DOE INCITE program.  We
thank NVIDIA Corporation for the donation of a Titan X and Titan V GPU
through their academic grant program.  This research has made use of
NASA's Astrophysics Data System Bibliographic Services.
\end{acknowledgements}

\facilities{NERSC, OLCF}

\software{\amrex~\citep{amrex_joss},
          \castro~\citep{castro,castro_joss},
          GCC (\url{https://gcc.gnu.org/}),
          helmeos \citep{timmes_swesty:2000},
          linux (\url{https://www.kernel.org/}),
          matplotlib (\citealt{Hunter:2007}, \url{http://matplotlib.org/}),
          NumPy \citep{numpy,numpy2},
          python (\url{https://www.python.org/}),
          valgrind \citep{valgrind},
          VODE \citep{vode},
          yt \citep{yt}}



%======================================================================
% References
%======================================================================

\bibliographystyle{aasjournal}
\bibliography{ws}


\end{document}
