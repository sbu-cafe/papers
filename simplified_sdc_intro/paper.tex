%\documentclass[times,modern]{aastex63}
\documentclass[times,preprint]{aastex63}

% these lines seem necessary for pdflatex to get the paper size right
\pdfpagewidth 8.5in
\pdfpageheight 11.0in

\usepackage[T1]{fontenc}
\usepackage{epsf,color,amsmath}

\usepackage{cancel}

\newcommand{\sfrac}[2]{\mathchoice%
  {\kern0em\raise.5ex\hbox{\the\scriptfont0 #1}\kern-.15em/
    \kern-.15em\lower.25ex\hbox{\the\scriptfont0 #2}}
  {\kern0em\raise.5ex\hbox{\the\scriptfont0 #1}\kern-.15em/
    \kern-.15em\lower.25ex\hbox{\the\scriptfont0 #2}}
  {\kern0em\raise.5ex\hbox{\the\scriptscriptfont0 #1}\kern-.2em/
    \kern-.15em\lower.25ex\hbox{\the\scriptscriptfont0 #2}} {#1\!/#2}}


\newcommand{\castro}{{\sf Castro}}
\newcommand{\maestroex}{{\sf MAESTROeX}}
\newcommand{\pynucastro}{{\sf pynucastro}}
\newcommand{\flash}{{\sf Flash}}
\newcommand{\amrex}{{\sf AMReX}}

\newcommand{\isot}[2]{$^{#2}\mathrm{#1}$}
\newcommand{\isotm}[2]{{}^{#2}\mathrm{#1}}

\newcommand{\gcc}{\mathrm{g~cm^{-3} }}
\newcommand{\cms}{\mathrm{cm~s^{-1} }}

\newcommand{\nablab}{{\mathbf{\nabla}}}
\newcommand{\Ub}{\mathbf{U}}
\newcommand{\gb}{\mathbf{g}}
\newcommand{\omegadot}{\dot{\omega}}
\newcommand{\Sdot}{\dot{S}}
\newcommand{\ddx}[1]{{\frac{{\partial#1}}{\partial x}}}
\newcommand{\ddxs}[1]{{\frac{{\partial}}{\partial x}}#1}
\newcommand{\ddt}[1]{{\frac{{\partial#1}}{\partial t}}}
\newcommand{\odt}[1]{{\frac{{d#1}}{dt}}}
\newcommand{\divg}[1]{{\nablab \cdot \left (#1\right)}}
\newcommand{\dedr}{\left . {\partial{}e}/{\partial\rho}\right |_{T, X_k}}
\newcommand{\dedrd}{\left . \frac{\partial{}e}{\partial\rho}\right |_{T, X_k}}
\newcommand{\dedX}{\left . {\partial{}e}/{\partial{}X_k} \right |_{\rho, T}}
\newcommand{\dedXd}{\left . \frac{\partial{}e}{\partial{}X_k} \right |_{\rho, T, X_{j,j\ne k}}}
\newcommand{\dedT}{\left . {\partial{}e}/{\partial{}T} \right |_{\rho,X_k}}
\newcommand{\dedTd}{\left . \frac{\partial{}e}{\partial{}T} \right |_{\rho,X_k}}

\newcommand{\Ic}{{\boldsymbol{\mathcal{I}}}}
\newcommand{\Ics}{{\mathcal{I}}}
\newcommand{\smax}{{s_\mathrm{max}}}
\newcommand{\kth}{k_\mathrm{th}}
\usepackage{bm}

\newcommand{\Uc}{{\,\bm{\mathcal{U}}}}
\newcommand{\Fb}{\mathbf{F}}
\newcommand{\Sc}{\mathbf{S}}

\newcommand{\xv}{{(x)}}
\newcommand{\yv}{{(y)}}
\newcommand{\zv}{{(z)}}

\newcommand{\ex}{{\bf e}_x}
\newcommand{\ey}{{\bf e}_y}
\newcommand{\ez}{{\bf e}_z}

\newcommand{\Ab}{{\bf A}}
\newcommand{\Sq}{{\bf S}_\qb}
\newcommand{\Sqhydro}{{\Sq^{\mathrm{hydro}}}}
\newcommand{\qb}{{\bf q}}

\newcommand{\Shydro}{{{\bf H}}}
\newcommand{\Hb}{{\bf H}}
\newcommand{\Rb}{{\bf R}}
\newcommand{\Rq}{{\bf R}}
\newcommand{\Adv}[1]{{\left [\boldsymbol{\mathcal{A}} \left(#1\right)\right]}}
\newcommand{\Advt}[1]{{\left [\boldsymbol{\mathcal{\tilde{A}}} \left(#1\right)\right]}}
\newcommand{\Advss}[1]{{\left [{\mathcal{{A}}} \left(#1\right)\right]}}
\newcommand{\Advsst}[1]{{\left [{\mathcal{\tilde{A}}} \left(#1\right)\right]}}
\newcommand{\Advs}[1]{\boldsymbol{\mathcal{A}} \left(#1\right)}

\newcommand{\avg}[1]{{\left \langle #1 \right \rangle}}

\newcommand{\nse}[1]{{\mathtt{NSE}( #1 )}}

\newcommand{\rhonse}{{\rho_\mathrm{nse}}}
\newcommand{\tnse}{{T_\mathrm{nse}}}
\newcommand{\Anse}{{A_\mathrm{nse}}}
\newcommand{\Bnse}{{B_\mathrm{nse}}}
\newcommand{\Cnse}{{C_\mathrm{nse}}}

\newcommand{\out}{{\rm out}}
\newcommand{\inp}{{\rm in}}

\newcommand{\atolspec}{{\epsilon_\mathrm{abs,spec}}}
\newcommand{\rtolspec}{{\epsilon_\mathrm{rel,spec}}}
\newcommand{\atolener}{{\epsilon_\mathrm{abs,ener}}}
\newcommand{\rtolener}{{\epsilon_\mathrm{rel,ener}}}

\setlength{\marginparwidth}{0.75in}
\newcommand{\MarginPar}[1]{\marginpar{\vskip-\baselineskip\raggedright\tiny\sffamily\hrule\smallskip{\color{red}#1}\par\smallskip\hrule}}

\begin{document}
%======================================================================
% Title
%======================================================================
%\title{A Simplified Spectral Deferred Correction Method for Coupling Hydrodynamics with Reaction Networks and Nuclear Statistical Equilibrium}
\title{An Improved Method for Coupling Hydrodynamics with Astrophysical Reaction Networks}

%\shorttitle{A Simplified SDC Method}
\shorttitle{Hydro/Reaction Coupling with NSE}


\shortauthors{}

\author[0000-0001-8401-030X]{M.~Zingale}
\affiliation{Dept.\ of Physics and Astronomy, Stony Brook University,
  Stony Brook, NY 11794-3800}

\author[0000-0003-0439-4556]{M.~P.~Katz}
\affiliation{Nvidia Corp}

\author[0000-0003-1791-0265]{A.~J.~Nonaka}
\affiliation{Center for Computational Sciences and Engineering, Lawrence Berkeley National Laboratory, Berkeley, CA  94720}

\author[0000-0002-1530-781X]{Alice Harpole}
\affiliation{Dept.\ of Physics and Astronomy, Stony Brook University,
             Stony Brook, NY 11794-3800}

\correspondingauthor{Michael Zingale}
\email{michael.zingale@stonybrook.edu}


%======================================================================
% Abstract and Keywords
%======================================================================
\begin{abstract}
Reacting astrophysical flows can be challenging to model because of
the difficulty in accurately coupling hydrodynamics and reactions.
This can be particularly acute during explosive burning or at high
temperatures where nuclear statistical equilibrium is established.  We
develop a simplified approach based on the ideas of spectral deferred
corrections (SDC) coupling of explicit hydrodynamics and stiff
reaction sources as an alternative to operator splitting or the more
comprehensive SDC approach we demonstrated previously.  We apply the
new method to some example problems with small and moderately-sized
astrophysical nuclear reaction networks and explore the timestep size
and reaction network tolerances to show that the simplified-SDC
approach compares favorably with traditional Strang operator
splitting.  This is all done in the framework of the
\castro\ hydrodynamics code, and all algorithm implementations are
freely available.
\end{abstract}

\keywords{hydrodynamics---methods: numerical}

%======================================================================
% Introduction
%======================================================================
\section{Introduction}\label{Sec:Introduction}

Modeling astrophysical reacting flows can be challenging because of
the disparity better the nuclear and hydrodynamics timescales.
Reaction networks tend to be stiff, requiring implicit integration
techniques to stably integrate the system~\citep{BYRNE19871}.  In contrast, compressible
hydrodynamics flows are limited by the (often much longer)
sound-crossing time over a computational cell and can be solved using
explicit time integration. Traditional methods of coupling
hydrodynamics and reactions used in astrophysics use operator
splitting---each physical process acts on the output of the previous
process in alternating fashion.  This makes it easy to use different
time-integration methods for the different physics, and to build a
simulation code in a modular way.  However, competition between the
different physical processes can cause the coupling to breakdown.
These splitting errors can lead to loss of accuracy and further time
step limitations.

A particularly difficult phase of evolution to model is the nuclear
statistical equilibrium that sets in for temperatures in excess of
$\mbox{few} \times 10^9~\mathrm{K}$.  Physically, the forward and
reverse rates of reaction should balance leading to an equilibrium.
With operator splitting, an NSE region will have a large positive flow
through the network in a zone in one step followed by a large negative
flow over the next timestep, as the code struggles to produce an
equilibrium.  These large changes in abundances (and large alternately
positive and negative energy generation rates) can be a challenge for
a code.  The easiest way to improve the coupling is to cut the
timestep (see, e.g., \citealt{couch:2015}), but this makes simulations
prohibitively expensive.  Sometimes the burning is simply halted on a
zone-by-zone basis when NSE conditions are reached (e.g., as in
\citealt{hedet}).  Alternately, at high temperatures, a reaction
network can be replaced with a table of NSE abundances and the zone's
composition set through table look-ups (e.g.\ \citealt{ma:2013}).  The
present work focuses on networks alone, but in a follow-on paper we
will explore hybrid burning models consisting of networks and NSE
tables.

The \castro\ hydrodynamics code \citep{castro,castro_joss} is used for
all of our numerical experiments.  \castro\ is a compressible
(magneto-, radiation-) hydrodynamics code built on the AMReX adaptive
mesh refinement (AMR) framework \citep{amrex_joss}.  \castro\ has been
designed to be performance portable and runs on massively parallel CPU
and GPU architectures \citep{castro_gpu}.  For hydrodynamics, the
corner transport upwind (CTU; \citealt{ppmunsplit}) method with the
piecewise parabolic method (PPM; \citealt{ppm,millercolella:2002}) is
used.  \castro\ includes self-gravity, rotation, arbitrary equations
of state and reaction networks, and has been used for modeling X-ray
bursts and different models of thermonuclear, core-collapse, and
pair-instability supernovae.  Recently in \citet{castro_sdc}, we
developed second- and fourth-order accurate methods in space and time
for coupling hydrodynamics and nuclear reaction networks based on
spectral deferred corrections (SDC) methods, and demonstrated the
method in a variety of test problems.

The time-integration approach presented here is considerably simpler
than the SDC method of \citet{castro_sdc}, but allows us to reuse the
main CTU \MarginPar{any cites to CCSE papers?}  hydrodynamics
construction and a largely similar ODE integration scheme, making this
method easier to add to existing simulation codes.  Furthermore, it
also extends to adaptive mesh refinement with subcycling in a
straightforward manner, avoiding the complications described in
\citep{mccorquodalecolella} needed to fill ghost cells when using
method-of-lines integration.  However, it is restricted to
second-order accuracy overall.  We term this algorithm the
``simplified-SDC method''.  In this paper we describe the overall
method and demonstrate it on a test problem and astrophysical
simulation using \castro.  All of the code to reproduce the results in
this paper are in the \castro\ github
repository\footnote{\url{https://github.com/amrex-astro/Castro/}}.

\section{Numerical Methodology}


We solve the Euler equations for compressible, reacting flow.  For ease
of exposition we describe the one-dimensional case;
multidimensional extensions are a straightforward modification to
include the CTU hydrodynamics scheme.  Our conserved variables are
\begin{equation}
  \Uc = \left ( \begin{array}{c}
           \rho \\
           \rho X_k \\
           \rho \alpha_l \\
           \rho u \\
           \rho E \\
           \rho e \end{array}\right )
\end{equation}
where $\rho$ is the mass density, $u$ is velocity, $E$ is specific
total energy, $p$ is the pressure, and we carry nuclear species mass
fractions, $X_k$.  The specific total
energy relates to the specific internal energy, $e$, as $E = e + u^2/2$,
and we also separately evolve $e$, as part of a dual
energy formulation (see \citealt{bryan:1995,wdmergerI}).
 The mass fractions are constrained to sum to 1, $\sum_k X_k = 1$, but
 no such constraint exists on the auxiliary variables. 
Defining the hydrodynamical fluxes:
\begin{equation}
  \Fb(\Uc) = \left ( \begin{array}{c}
         \rho u \\
         \rho X_k u \\
         \rho u^2 p \\
         (\rho E + p) u \\
         \rho e u \end{array}\right )
\end{equation}
We can write the system in conservative form for all state variables aside from $(\rho e)$ as:
\begin{equation}
  \ddt{\Uc} + \ddx{\Fb(\Uc)} = \Sc(\Uc)
\end{equation}
where for the special case of $(\rho e)$, we have an additional ``pdV'' term:
\begin{equation}
\ddt{(\rho e)} + \ddx{F(\rho e)} + p \ddx{u} = S(\rho e)
\end{equation}

We'll split the source term, $\Sc(\Uc)$ into pure hydrodynamic and reactive parts:
\begin{equation}
  \label{eq:cons_sources}
  \Hb(\Uc) = \left ( \begin{array}{c}
    0 \\
    0 \\
    \rho g \\
    \rho u g \\
    0 \end{array} \right )
  \qquad
  \Rb(\Uc) = \left ( \begin{array}{c}
     0 \\
     \rho \omegadot(X_k) \\
     0 \\
     \rho \dot{S} \\
     \rho \dot{S} 
  \end{array} \right )
\end{equation}
with 
\begin{equation}
  \Sc(\Uc) = \Hb(\Uc) + \Rb(\Uc).
\end{equation}
Here, gravity, represented by the gravitational acceleration $g$
appears as a pure hydrodynamical source term.  From reactions,
$\omegadot(X_k)$ is the creation rate for species $k$
 and $\dot{S}$ is the energy generation rate per unit
mass.  We note that the internal energy ``pdV'' work is not treated as
a source term but is instead constructed with the hydrodynamical
fluxes are computed in the CTU method.
Aside from the $p\partial u/\partial x$ (``pdV'') term in the internal
energy equation, this system is in conservative form with source
terms.

We'll define the advective terms with hydrodynamic sources, $\Advs{\Uc}$ as
\begin{equation}
\Advs{\Uc} = -\ddx{\Fb(\Uc)} + \Hb(\Uc)
\end{equation}
for the general case, with the $(\rho e)$ component again having the extra
``pdV'' term:
\begin{equation}
\mathcal{A}(\rho e) = -\ddx{F(\rho e)} -p \ddx{u} + H(\rho e)
\end{equation}


To close the system, we need the equation of state.  For a system
where the composition is completely specified by the mass fractions,
$X_k$, the equation of state would take the form:
\begin{equation}
p = p(\rho, X_k, e)
\end{equation}


Sometimes it is preferable to work with the primitive variables,
\begin{equation}
\qb = \left ( \begin{array}{c}
  \rho \\
  X_k \\
  u \\
  p \\
  (\rho e) \\
\end{array} \right )
\end{equation}
Here, the system appears
as:
\begin{equation}
\qb_t + \Ab^\xv(\qb) \qb_x  = \Sc(\qb)
\end{equation}
with the matrix $\Ab^\xv$ giving the coefficients of the spatial derivatives
of the primitive variables:
\begin{equation}
\Ab^\xv(\qb) = \left ( \begin{array}{ccccc}
    u & 0 &  \rho & 0 & 0 \\
    0 & u &  0    & 0 & 0 \\
    0 & 0 &  u    & 1/\rho & 0 \\
    0 & 0 &  \Gamma_1 p & u & 0 \\
    0 & 0 &  \rho h & 0 & u
  \end{array} \right )
\end{equation}
where $h$ is the specific enthalpy and $\Gamma_1$ is an adiabatic index,
$\Gamma_1 = d\log p/d\log\rho|_s$ at constant entropy.
The CTU+PPM algorithm uses the characteristic wave structure of $\Ab$
to collect the information that makes it to an interface over a timestep
in order to compute the fluxes through the interface.
Note, the primitive state has two thermodynamic quantities, $p$
and $(\rho e)$, to more efficiently handle the general equation of
state in the Riemann solver, as described in \citet{castro}, but
alternate formulations are possible \citep{colellaglaz:1985}.
The source term vector, $\Sc(\qb)$, can again be decomposed into hydrodynamic
sources (now in terms of the primitive variables) and reaction terms,
\begin{equation}
  \Sc(\qb) = \Hb(\qb) + \Rb(\qb)
\end{equation}
with
\begin{equation}
\label{eq:prim_sources}
\Hb(\qb) = \left ( \begin{array}{c}
     0 \\
     0 \\
     g \\
     0 \\
     0 \\
   \end{array} \right )
\qquad
\Rb(\qb) = \left ( \begin{array}{c}
     0 \\
     \omegadot(X_k) \\
     0 \\
     \Gamma_1 p \sigma \Sdot \\
     \rho \Sdot
   \end{array} \right )
\end{equation}
where
\begin{equation}
\sigma \equiv \frac{\partial p/\partial T |_\rho}{\rho c_p \partial p/\partial \rho |_T}
\end{equation}
and $c_p$ is the specific heat at constant pressure, $c_p = \partial
h/\partial T |_p$.  A derivation of this source for the pressure
equation can be found in \cite{ABNZ:III}.  We note that this source is
algebraically identical to that shown in Eq.~25 of \cite{castro}.

The CTU+PPM method for hydrodynamics is second-order accurate in space
and time.  We want to couple the reactive sources to the hydrodynamics
to be second-order in time as well.  As discussed above, nuclear
reaction sources are stiff, and need to be integrated using implicit
methods for stabilty.  Operator splitting (e.g., Strang) is
traditionally employed here, and is used as a benchmark for comparison
in this paper.  We'll discuss this traditional approach next before moving
on to our new time-coupling method.  Figures~\ref{fig:flowchart_I} and \ref{fig:flowchart_II} show a graphical
flowchart of the reaction and hydrodynamics advances in the two methods.

\begin{figure}[t]
\plotone{sdc_strang_flowchart_I}
\caption{\label{fig:strang_flowchart} Flowchart of the operator split,
  Strang, time integration.  We first react for $\Delta t/2$, then
  advect for $\Delta t$, and finally react for $\Delta t/2$.  Each
  process uses the state left behind from the previous process.}
\end{figure}

\begin{figure}[t]
\plotone{sdc_strang_flowchart_II}
\caption{\label{fig:sdc_flowchart} Flowchart of the simplified-SDC
  approach.  An iteratively-lagged advection term is used to update
  the system to the new time, with each iteration improving the
  coupling.}
\end{figure}



\subsection{Strang Splitting}

In Strang splitting, we first integrate the system with reactions terms only (no advection)
over $\Delta t/2$, then integrate the advection terms only (no reactions) over $\Delta t$,
and finally integrate the reaction terms only over $\Delta t/2$.

In the absence of advective terms, our reaction system appears as just
$d\Uc/dt = \Rb(\Uc)$, or:
\begin{align}
\odt{\rho} & = 0 \\
\odt{(\rho X_k)} &= \rho \omegadot(X_k) \\
\odt{(\rho u)} &= 0 \\
\odt{(\rho E)} &= \rho \Sdot
\end{align}
We can write the energy equation as:
\begin{equation}
\odt{(\rho E)} = \odt{(\rho e)} + \odt{K} = \rho \Sdot
\end{equation}
where $K$ is the kinetic energy, $K = \rho |u|^2/2$.  Since the density and velocity
are unchanged by reactions (when Strang splitting), our energy equation becomes:
\begin{equation}
\label{eq:strang:e}
\odt{(\rho e)} = \rho \odt{e} = \rho \Sdot
\end{equation}
The reaction rates are typically expressed as $\omegadot_k(\rho, T, X_k)$
when we evolve this system, which requires us to get temperature from
the equation of state each
time we need to evaluate the reactive terms.  

We also typically integrate mass fraction itself, instead of partial
densities:
\begin{equation}
\label{eq:strang:X}
\odt{X_k} = \omegadot_k
\end{equation}
We integrate Equations (\ref{eq:strang:e}) and (\ref{eq:strang:X})
using an implicit ODE solver described below.

We explored this and other approaches (including not evolving an
energy / temperature equation during the reaction step) in
\citet{strang_rnaas} and showed that the above formulation gets second
order convergence and showed that integrating an energy / temperature
equation is needed to get second order accuracy (see also
\citealt{muller:1986} for a discussion on stability).  We note however
that some astrophysical simulation codes only evolve the species
equations.  For very strong reactions, when using Strang splitting the
state can drift significantly off of the smooth solution to the
coupled reactive hydrodynamics equations, as shown graphically in
\citet{astronum:2018} (using an earlier version of the present
algorithm).  A variation on Strang splitting called (re-)balanced
splitting was developed in \citet{speth:2013}, but we do not explore
that here. \MarginPar{keep this sentence?}


\subsection{Timestep Limiters and Retry Mechanism}

Since this method is based off of the CTU hydrodynamics scheme, it
benefits from the larger timestep that method can take (when done with
full corner coupling, the advective CFL condition is unity) as
compared to a method-of-lines approach (see \citealt{ppmunsplit}).  In
addition to the standard CFL timestep limiter for explicit
hydrodynamics, timestep limiters based on
the energy generation or abundance changes over a timestep, such as
those introduced in \cite{prometheus}, are often used.  An energy limiter takes the
form of either:
\begin{equation}
\label{eq:dt:nuce_I}
\Delta t \le f_e\, \min_{i} \left\{\frac{e^n_{i}}{|\dot{S}_{i}^n|}\right\} \\
\end{equation}
or
\begin{equation}
\label{eq:dt:nuce_II}
\Delta t \le f_e\, \min_{i} \left\{ \frac{e^n_i}{|\int \dot{S}_i(t) dt|} \right\}
\end{equation}
where $i$ is the zone index and $f_e$ is a parameter used to control
the allowed change (e.g., $f_e = 0.5$ will limit the step such that
reactions can only increase the internal energy by 50\%).  The two
formulations differ in that Eq.~\ref{eq:dt:nuce_I} uses the
instantaneous evaluation of the energy generation rate at the start of
the timestep while Eq.~\ref{eq:dt:nuce_II} uses the integral of the
energy generation rate over the entire step (or last Strang half).

\castro\ has the ability to reject a timestep if it detects a failure
and retry with smaller timesteps (subcycling to make up the original
required timestep).  Among the conditions that can trigger this are
density falling below zero during advection, the ODE integration
failing to converge in the implicit solve (due to too many steps or
the internal timestep falling below a minimum), or violation of one of
the timestep limiters during the step.  This means that equation
(\ref{eq:dt:nuce_I}) or (\ref{eq:dt:nuce_II}) are not reactive, but
instead guaranteed to be met throughout the simulation, because the
step is rejected if they are violated.  This contrasts to similar
approaches used in other codes where conditions \ref{eq:dt:nuce_I} or
\ref{eq:dt:nuce_II} are used to restrict the next timestep size, but
the update over the current step is kept, which already violated the
constraints. \MarginPar{would be nice to have a reference here} The
retry mechanism in \castro\ works with both the Strang and
simplified-SDC integration scheme.  Retrying the step is much more
stringent that simply adjusting the next step, so we put a cap on the
number of retries allowed, aborting if we exceed the cap.



\subsection{Spectral Deferred Corrections}

The basic idea of spectral deferred corrections \MarginPar{ref} is to express the
update as an integral and divide the time-update into a number of
discrete time nodes.  The integral is then approximated using a
quadrature rule over these time nodes and low order approximations are
used to update the state from one time node to the next.  The method
uses iteration to successively improve the solution and the ultimate
accuracy is determined by the quadrature method used to evaluate the
integral, which is done using an iteratively-lagged solution.  This is the
classic approach that we implemented in \cite{castro_sdc}.

Our simplified-SDC approach is based on the method described in \citet{SDC-old} and
a similar (but unpublished) implementation in the \maestroex\ simulation code \cite{maestroex}.
We again start by considering the update
in integral form:
\begin{equation}
\Uc^{n+1} = \Uc^n + \int_t^{t+\Delta t} \left [ \Advs{\Uc} + \Rb(\Uc) \right ] dt,
\end{equation}
In this approach, we 
approximate the advective term
piecewise constant in time, using the value at the midpoint in time,
to achieve second-order accuracy, giving us:
\begin{equation}
\label{eq:integral:simplesdc}
\Uc^{n+1} = \Uc^n + \int_t^{t+\Delta t} \left \{ \Adv{\Uc}^{n+1/2} + \Rb(\Uc) \right \} dt
\end{equation}
The \castro\ version of the simplified-SDC algorithm
differs from the previous versions due to the need to do some operations
on the conserved variable state and some on the primitive variable
state. 

The basic time update algorithm proceeds as:

\begin{itemize}

\item {\em Initialization}

\label{sec:initialization}

  \begin{itemize}
  \item We need an approximation of how much the reactions alone
    changed the primitive variable state over the timestep, which we
    will denote $\Ic_q$ (this is basically an approximation of
    $\Rb(\qb)$).

    Since we do not have any information about the current
    timestep in the first iteration, we use the value from the last
    iteration of the previous timestep:
    \begin{equation}
      \Ic^{n+1/2,(0)}_{\qb} = \Ic^{n-1/2,(\smax)}_{\qb}
    \end{equation}
  %% \item Solve the Poisson problem for the initial gravitational potential:
  %%   \begin{equation}
  %%     \nabla^2 \Phi^n = 4\pi G \rho^n
  %%   \end{equation}

  %% \item Set the first guess at the new time potential as
  %%   $\Phi^{n+1,(0)} = \Phi^n$.

  \end{itemize}

\item {\em Iterate}

  Iterate from $k = 1, \ldots, \smax$.  For second-order accuracy,
  $\smax = 2$ is sufficient.  In addition to denoting the time-level
  with a superscript (like $n$ or $n+1$), we'll use a second subscript
  in parentheses to keep track of the iteration.  A single iteration, $k$,
  starts with $\Uc^n$ and results in the new time-level state for that
  iteration, $\Uc^{n+1,(k)}$.

  \begin{itemize}
  \item {\em Create the advective update term, $\Adv{\Uc}^{n+1/2,(k)}$}

    \begin{itemize}
    \item convert $\Uc \rightarrow \qb$.  This is an algebraic transformation,
      but will require the EOS.

    \item predict $\qb$ to the interfaces at $t^{n+1/2}$ using the CTU PPM
      method.  The source terms, $\Sq$, used in the prediction are:
      \begin{equation}
        \Sc(\qb) = \Hb(\qb) + \Ic_\qb^{n+1/2,(k-1)}
      \end{equation}
      Here we use the iteratively lagged integrals of the primitive variable
      terms accounting only for reactions, $\Ic_\qb^{n+1/2,(k-1)}$, as the
      reactive source.  This is in contrast to Strang-splitting, where no
      explicit reactive source terms are seen by the hydrodynamics update.
%%       Any hydrodynamic source terms are time-centered
%%       using the previous iteration:
%% \MarginPar{Formally both $t^n$ or $t^{n+1/2}$ sources give you 2nd-order since they are CTU predictor source terms.  I've never found this type of iteration for this term to amount to any benefit}
%%       \begin{equation}
%%         \Sqhydro^{n+1/2} = \frac{1}{2} \left ( \Sqhydro^n + \Sqhydro^{n+1,(k-1)} \right )
%%       \end{equation}

      In the unsplit CTU method \citep{ppmunsplit}, the interface
      states used for the final Riemann problem through the zone
      interface consist of a normal predictor and a transverse flux
      correction.  We can add the source terms either to the normal
      predictor (for example, doing characteristic tracing as
      described in \citealt{ppm}) or after all of the transverse flux
      corrections are made.  Both are second-order accurate.  For the
      hydrodynamics sources, we do those in the normal predictor.
      However, for the reactive sources, we found that it is most
      reliable to add them at the end of the interface state
      construction, after the transverse flux corrections.  This is
      because we want to ensure that sum over species of $\Ic_\qb$ is
      zero, and characteristic tracing or the various flux corrections
      may not preserve this.  We enforce that the species interface
      states remain in $[0, 1]$ after adding the reactive source.


    \item solve the Riemann problem at each interface to get a unique
      conserved state on each interface, $\Uc^{n+1/2,(k)}_{i+1/2}$

    \item construct the advective update terms, $\Advt{\Uc}^{n+1/2,(k)}_{i}$,
      by first ignoring the hydrodynamics sources,
      \begin{equation}
        \Advt{\Uc}^{n+1/2,(k)}_{i} =
          - \frac{\Fb^\xv(\Uc^{n+1/2,(k)}_{i+1/2}) - \Fb^\xv(\Uc^{n+1/2,(k)}_{i-1/2})}{\Delta x}
      \end{equation}
      for the general case, and
      \begin{align}
        \Advsst{\rho e}^{n+1/2,(k)}_{i} =
          &- \frac{F\left((\rho e)^{n+1/2,(k)}_{i+1/2}\right) - F\left((\rho e)^{n+1/2,(k)}_{i-1/2}\right)}{\Delta x} \\
          &- \left (\frac{p_{i+1/2}^{n+1/2,(k)} + p_{i-1/2}^{n+1/2,(k)}}{2} \right )\frac{u_{i+1/2}^{n+1/2,(k)} - u_{i-1/2}^{n+1/2,(k)}}{\Delta x}
      \end{align}
      for $(\rho e)$.

    Now the conservative hydrodynamics source terms are computed by first updating to the
    new state with advection and the old-time source term applied for the full $\Delta t$ as: 
    \begin{equation}
      \Uc^{\star\star} = \Uc^n + \Delta t \Advt{\Uc}^{n+1/2,(k)} + \Delta t \Hb(\Uc^n)
    \end{equation}
    %% first updating the density to the new state with advection only as:
    %% \begin{equation}
    %%   \rho^{\star\star} = \rho^n + \Delta t \Advt{\rho}^{n+1/2,(k)}
    %% \end{equation}
    %% then constructing the momentum source term:
    %% \begin{equation}
    %%   {\bf S}_{\rho\Ub}^{n+1/2} = \frac{1}{2} (\rho^n \gb^n + \rho^{\star\star} \gb^{n+1,(k-1)})
    %% \end{equation}
    %% Then updating the momentum with only advection as:
    %% \begin{equation}
    %%   (\rho \Ub)^{\star\star} = (\rho \Ub)^n + \Delta t \Advt{\rho\Ub}^{n+1/2,(k)} + \Delta t {\bf S}_{\rho\Ub}^{n+1/2}
    %% \end{equation}
    %% and finally constructing the energy source:
    %% \begin{equation}
    %%   S_{\rho E}^{n+1/2} = \frac{1}{2} \left [ (\rho\Ub)^n \cdot \gb^n + (\rho\Ub)^{\star\star} \cdot \gb^{n+1,(k-1)}
    %%     \right ]
    %% \end{equation}
    We then evaluate the source terms with $\Uc^{\star\star}$ and
    correct the advective term so that we have a time-centered
    source.
    The final advective update term is then\footnote{For a source like gravity, this update can be done first for $\rho$ and then define the new momentum source using $\rho^{\star\star}$ and likewise for energy}:
    \begin{equation}
      \Adv{\Uc}^{n+1/2,(k)}_{i} = \Advt{\Uc}^{n+1/2,(k)}_{i} +
      \frac{\Delta t}{2} \left (\Shydro(\Uc^n) + \Shydro(\Uc^{\star\star}) \right )
    \end{equation}

    %% with
    %% \begin{equation}
    %%   \Shydro^{n+1/2} = \left ( \begin{array}{c}
    %%                  0 \\ 0 \\ 0 \\
    %%                 {\bf S}_{\rho\Ub}^{n+1/2} \cdot \ex \\
    %%                 S_{\rho E}^{n+1/2} \end{array} \right )
    %% \end{equation}

    We note that this procedure works because the source terms here do
    not depend on the outcome of the reactions.

    \end{itemize}

  \item {\em Update the System Using a Method of Lines Integration}

    We update the state by doing the integral in equation
    (\ref{eq:integral:simplesdc}).  Since we are approximating the
    advective term as piecewise constant in time, we can simply use an
    ODE integrator to integrate this, just as we do with the reaction
    system in Strang splitting.  The difference here being that we are
    integrating the conserved variables and the state sees the effect
    of advection as we integrate the reactions.  So rather than use
    $d\Uc/dt = \Rb(\Uc)$, the ODE form we use is
    \begin{equation}
      \odt{\Uc} = \Adv{\Uc}^{n+1/2,(k)} + \Rb(\Uc)
    \end{equation}

    Looking at the form of Eq.~\ref{eq:cons_sources}, we see that only
    the species and energies have source terms.  The total and
    internal energies both provide the same information, and
    integrating both overconstrains the system, so we just integrate
    the internal energy.  We define the subset of variables that are
    directly integrated as:
    \begin{equation}
      \Uc^\prime = \left ( \begin{array}{c} \rho X_k \\ \rho e \end{array} \right )
    \end{equation}
    and we integrate
    \begin{equation}
      \odt{\Uc^\prime} = \Adv{\Uc^\prime}^{n+1/2,(k)} + \Rb(\Uc^\prime)
    \end{equation}
    This integration begins with $\Uc^{\prime,n}$ and results in $\Uc^{\prime,n+1,(k)}$.

    We will need the density at times during the integration, which we construct as:
    \begin{equation}
      \rho(t) = \rho^n + \Advss{\rho}^{n+1/2,(k)} \, (t - t^n)
    \end{equation}
    As we are integrating this system we need to get the temperature,
    $T$, for the rate evaluations.  We obtain this by directly from
    internal energy, composition, and density using the equation of
    state.

    Our integrator also needs the Jacobian of the system, in terms of
    the $\Uc^\prime$.  This is different than the form of the
    Jacobian usually used in reaction networks.  We describe the form
    of the Jacobian in appendix \ref{sec:app:jacobian}.


    At the end of the integration, we can do the conservative update of momentum
    and energy.  Momentum is straightforward, since there are no reactive sources:
    \begin{equation}
      (\rho u)^{n+1} = (\rho u)^n + \Delta t \Advss{\rho u}^{n+1/2,(k)}
    \end{equation}
    For total energy, we first need to isolate the reactive source for energy:
    \begin{equation}
      (\rho \Sdot)^{n+1/2} = \frac{(\rho e)^{n+1} - (\rho e)^n}{\Delta t} - \Advss{\rho e}^{n+1/2,(k)}
    \end{equation}
    Then the update is
    \begin{equation}
      (\rho E)^{n+1} = (\rho E)^n + \Delta t \Advss{\rho E}^{n+1/2,(k)} + \Delta t (\rho \Sdot)^{n+1/2}
    \end{equation}

  \item {\em Compute the Reactive Source Terms.}

    We now seek the $\Ic$'s that capture the effect of just the
    reaction sources on the state variables for the next iteration.
    For the conserved quantities, these would simply be:
    \begin{equation}
      \Ic^{(k)}_{\Uc} = \frac{\Uc^{n+1,(k)} - \Uc^n}{\Delta t} - \Adv{\Uc}^{n+1/2,(k)}
    \end{equation}
    However, for our primitive variables, which are used in the
    interface state prediction, we need to construct the required source terms more
    carefully.  We want:
    \begin{equation}
      \label{eq:Iq}
      \Ic^{(k)}_{\qb} = \frac{\qb^{n+1,(k)} - \qb^n}{\Delta t} - \Adv{\qb}^{n+1/2,(k)}
    \end{equation}
    but we need the advective update for $\qb$, which we have not
    constructed.  We note that $\Ic^{(k)}_\qb$ is an approximation to the integral of 
    Eq.~\ref{eq:prim_sources} over the timestep.  Additionally, we cannot simply use the equation of
    state on $\Ic^{(k)}_{\Uc}$ since this is a time-derivative and
    does not represent a well-defined state in itself.  Instead, we
    derive $\Ic^{(k)}_{\qb}$ via a multi-step process.  We first find
    the conservative state as if it were updated only with advection:
    \begin{equation}
      \Uc^\star = \Uc^n + \Delta t \Adv{\Uc}^{n+1/2,(k)}
    \end{equation}
    and then construct the corresponding primitive variable state via an algebraic transform,
    $\Uc^\star \rightarrow \qb^\star$.
    This allows us to define the advective update for $\qb$ as:
    \begin{equation}
      \Adv{\qb}^{n+1/2,(k)} = \frac{\qb^\star - \qb^n}{\Delta t}
    \end{equation}
    Defining the primitive state corresponding to the fully-updated
    conserved state via an algebraic transform, $\Uc^{n+1,(k)}
    \rightarrow \qb^{n+1,(k)}$, we can construct $\Ic^{(k)}_{\qb}$ as given
    in Equation (\ref{eq:Iq}).
    Putting all of this together, we see:
    \begin{equation}
      \Ic^{(k)}_{\qb} = \frac{\qb^{n+1,(k)} - \qb^\star}{\Delta t}
    \end{equation}



  %% \item {\em Solve for the New Gravitational Potential.}

  %%   We solve
  %%   \begin{equation}
  %%     \nabla^2 \Phi^{n+1,(k)} = 4\pi G \rho^{n+1,(k)}
  %%   \end{equation}

  \end{itemize}

\end{itemize}

This completes the update of a single iteration.

\subsection{Stiff ODE Integrator}

We use a modified version of the VODE~\citep{vode} integrator,
designed for stiff ODEs.  Our version has been ported C++, as a
header-only library enabling it to run on GPUs.  We have also added
checks to the timestep rejection logic that help prevent VODE from
wandering too far off the solution\footnote{This modified version of
VODE is available in our Microphysics repo:
\url{https://github.com/starkiller-astro/Microphysics}.}  These have
been shown empirically to improve the performance of VODE.

VODE allows us to specific both relative and absolute tolerances
for the species and energy during the integration.  They are combined
into a weight that VODE uses to assess convergence of the step:
\begin{equation}
w_i = \epsilon_\mathrm{rel} |y_i| + \epsilon_\mathrm{abs}
\end{equation}
for integration variable $y_i$.  We will denote the species tolerances
as $\rtolspec$ and $\atolspec$ and the energy tolerances as $\rtolener$ and
$\atolener$.

For Strang, we require that
an individual mass fraction not change too much over a step:
\begin{equation}
\label{eq:vode_species_reject}
\begin{array}{c}|X_k^{m+1}| < f |X_k^m| \\ |X_k^{m+1}| > \frac{1}{f} |X_k^m| \end{array} ~  \mbox{if}~ |X_k^m| > \eta \atolspec ~\mbox{and}~ |X_k^{m+1}| > \eta \atolspec 
\end{equation}
Here, $m$ is the current VODE solution and $m+1$ is the potential
new-time solution.  The parameter $f$ is the factor a mass fraction is
allowed to change per VODE step.  We use $f = 4$ for the results here.
The parameter $\eta$ allows us to only use this condition for species
with mass fractions above a threshold.  We use $\eta = 1$ by default,
but $\eta = f$ sometimes helps prevent VODE from worrying about
species that dip below the threshold during integration, since VODE
uses a norm over all of the integrated variables to compute the total
error.  If these conditions are violated, then VODE will reject the
timestep and retry with a smaller step.  We also require that the mass
fractions are contained in $[0, 1]$ to a tolerance of $10^{-2}$.

For SDC, we enforce these same constraints, but for
Eq.~\ref{eq:vode_species_reject}, we only use the change from $m$ to
$m+1$ due to reactions, by subtracting off the advective contribution
over that substep.  We also require that:
\begin{align}
\rho^{m+1} &> 0 \\
(\rho e)^{m+1} &> 0
\end{align}

For both Strang and simplified-SDC, we will use a numerical Jacobian.
VODE computes it internally for Strang and we use the method from
Appendix \ref{app:jacobian} for the simplified-SDC method.  VODE
employs Jacobian-caching, so the Jacobian does not need to be
re-evaluated each time it is used.


\section{Tests}

\subsection{Reacting convergence test problem}

\cite{castro_sdc} introduced a test problem for measuring convergence
of a reacting hydrodynamic algorithm.  This is based on the acoustic
pulse problem from \citep{mccorquodalecolella}, and was also used in
\citep{strang_rnaas}.  A periodic domain with a uniform entropy is
initialized with a pressure profile with a small perturbation.  This
drives a low amplitude acoustic wave radially outward from the center.
A simple reaction network with the triple-alpha and
$\isotm{C}{12}(\alpha,\gamma)\isotm{O}{16}$ rates releases energy.  By
running at different resolutions, with a fixed timestep that scales
with resolution, we can compute the convergence rate.  In order to
demonstrate second-order convergence, the problem must be smooth (so
the slope limiters don't kick in severely), which means that the
energy release cannot be so vigorous as to drive shocks.  test here
with the simplified SDC algorithm.



% EOS: /home/zingale/development/Microphysics/EOS/helmholtz
% NETWORK: /home/zingale/development/Microphysics/networks/triple_alpha_plus_cago

% Castro       git describe: 21.12-9-gd7a27ccd5
% AMReX        git describe: 21.12-64-gfde72340e
% Microphysics git describe: 21.12-12-g9595a34f


\begin{deluxetable}{lllllll}
\tablecaption{\label{table:react_converge_strang} Convergence ($L_1$ norm) for the reacting convergence problem using Strang splitting.}
\tablehead{\colhead{field} & \colhead{$\epsilon_{64 \rightarrow 128}$} & 
           \colhead{rate} & \colhead{$\epsilon_{128\rightarrow 256}$} & 
           \colhead{rate} & \colhead{$\epsilon_{256\rightarrow 512}$}}
\startdata
 $\rho$                      & $2.794 \times 10^{18}$  & 2.044  & $6.777 \times 10^{17}$  & 2.554  & $1.154 \times 10^{17}$  \\
 $\rho u$                    & $6.796 \times 10^{26}$  & 2.448  & $1.245 \times 10^{26}$  & 2.889  & $1.681 \times 10^{25}$  \\
 $\rho v$                    & $6.796 \times 10^{26}$  & 2.448  & $1.245 \times 10^{26}$  & 2.889  & $1.681 \times 10^{25}$  \\
 $\rho E$                    & $2.451 \times 10^{35}$  & 2.351  & $4.803 \times 10^{34}$  & 2.742  & $7.179 \times 10^{33}$  \\
 $\rho e$                    & $2.261 \times 10^{35}$  & 2.320  & $4.526 \times 10^{34}$  & 2.821  & $6.403 \times 10^{33}$  \\
 $T$                         & $2.237 \times 10^{21}$  & 1.691  & $6.927 \times 10^{20}$  & 2.482  & $1.240 \times 10^{20}$  \\
 $\rho X(\isotm{He}{4})$     & $2.878 \times 10^{18}$  & 2.020  & $7.096 \times 10^{17}$  & 2.529  & $1.229 \times 10^{17}$  \\
 $\rho X(\isotm{C}{12})$     & $1.698 \times 10^{17}$  & 1.950  & $4.393 \times 10^{16}$  & 2.232  & $9.353 \times 10^{15}$  \\
 $\rho X(\isotm{O}{16})$     & $1.687 \times 10^{14}$  & 1.660  & $5.338 \times 10^{13}$  & 1.957  & $1.375 \times 10^{13}$  \\
 $\rho X(\isotm{Fe}{56})$    & $2.794 \times 10^{8}$   & 2.044  & $6.777 \times 10^{7}$   & 2.554  & $1.154 \times 10^{7}$   \\
\enddata
\end{deluxetable}



\begin{deluxetable}{lllllll}
\tablecaption{\label{table:react_converge_sdc} Convergence ($L_1$ norm) for the reacting convergence problem using SDC integration (2 iterations).}
\tablehead{\colhead{field} & \colhead{$\epsilon_{64 \rightarrow 128}$} & 
           \colhead{rate} & \colhead{$\epsilon_{128\rightarrow 256}$} & 
           \colhead{rate} & \colhead{$\epsilon_{256\rightarrow 512}$}}
\startdata
 $\rho$                      & $2.784 \times 10^{18}$  & 2.048  & $6.734 \times 10^{17}$  & 2.558  & $1.143 \times 10^{17}$  \\
 $\rho u$                    & $6.779 \times 10^{26}$  & 2.447  & $1.243 \times 10^{26}$  & 2.895  & $1.671 \times 10^{25}$  \\
 $\rho v$                    & $6.779 \times 10^{26}$  & 2.447  & $1.243 \times 10^{26}$  & 2.895  & $1.671 \times 10^{25}$  \\
 $\rho E$                    & $2.450 \times 10^{35}$  & 2.353  & $4.795 \times 10^{34}$  & 2.737  & $7.193 \times 10^{33}$  \\
 $\rho e$                    & $2.256 \times 10^{35}$  & 2.320  & $4.518 \times 10^{34}$  & 2.817  & $6.414 \times 10^{33}$  \\
 $T$                         & $2.232 \times 10^{21}$  & 1.695  & $6.893 \times 10^{20}$  & 2.484  & $1.233 \times 10^{20}$  \\
 $\rho X(\isotm{He}{4})$     & $2.866 \times 10^{18}$  & 2.024  & $7.049 \times 10^{17}$  & 2.534  & $1.217 \times 10^{17}$  \\
 $\rho X(\isotm{C}{12})$     & $1.695 \times 10^{17}$  & 1.959  & $4.357 \times 10^{16}$  & 2.236  & $9.250 \times 10^{15}$  \\
 $\rho X(\isotm{O}{16})$     & $1.681 \times 10^{14}$  & 1.662  & $5.313 \times 10^{13}$  & 1.963  & $1.363 \times 10^{13}$  \\
 $\rho X(\isotm{Fe}{56})$    & $2.784 \times 10^{8}$   & 2.048  & $6.734 \times 10^{7}$   & 2.558  & $1.143 \times 10^{7}$   \\
\enddata
\end{deluxetable}

Tables \ref{table:react_converge_strang} and
\ref{table:react_converge_sdc} show the Strang and simplified-SDC
convergence respectively.  We see that both methods converge nearly
second order, and agree well with each other.

\subsection{Sub-Chandra Double Detonation}

We next model a double detonation Type Ia
supernova.  In this model, a detonation begins in the accreted helium
layer on a sub-Chandrasekhar mass white dwarf and that detonation can
either drive a compression wave into the core igniting a second
detonation in the carbon / oxygen core, or burn through the interface
at the base of the accreted layer producing an inward propagating
carbon detonation.  Our goal here is not to explore the feasibility of
the model or understand whether a detonation propagating through the
He-C interface is physical, but rather to look at the coupling of the
hydrodynamics and reactions.  For that reason, we explore only a
single model and start off with a rather large temperature
perturbation in the He layer.

We use a network with 28 nuclei and 96 rates that captures He burning \MarginPar{should I do a few aprox13 runs for comparison?}
with links for $(\alpha,p)(p,\gamma)$ reactions and the rates
involving \isot{N}{14} to bypass
$\isotm{C}{12}(\alpha,\gamma)\isotm{O}{16}$ as described in
\cite{shenbildsten}.  The rates are taken from the ReacLib library
\citep{reaclib} and the network is written by
\pynucastro~\citep{pynucastro} directly in the C++ format that our
code requires.  The nuclei and links in the network are shown in
Figure~\ref{fig:subch_network}.  This moderate-sized network with many
reaction pathways (forward and reverse) make it a good test for the
coupling between hydro and reactions.  An overview of the network is
shown in Figure~\ref{fig:subch_network}.  This network is available 
as {\tt subch2} in \citep{microphysics}.


\begin{figure}[t]
\centering
\plotone{subch2}
\caption{\label{fig:subch_network} Reaction network for the double detonation problem.}
\end{figure}


The initial model is generated following the procedure described in
\citep{subchandra}.  We use a $1.1~M_\odot$ carbon white dwarf with a
$0.05~M_\odot$ He layer.  We seed the He layer with 1\% (by mass) of
\isot{N}{14}.  The white dwarf is isothermal and the temperature ramps
up at the base of the He layer and is then isentropic until the
surface.  Figure~\ref{fig:subch_initial_model} shows the structure of
the initial model.  We use 2d axisymmetric coordinates with a domain
size of $1.024\times 10^9~\mathrm{cm} \times 2.048\times
10^9~\mathrm{cm}$, a base grid of $256 \times 512$ zones and two
levels of refinement (both jumping by $2\times$), giving a fine-grid
resolution of $10~\mathrm{km}$.  Gravity is modeled as a monopole.
Our choice of initial perturbation has the detonation propagate inward
into the carbon white dwarf.  We run the simulation for 0.1 s---this
is enough time for the carbon detonation to be well developed.

\begin{figure}[t]
\centering
\plotone{initial_model}
\caption{\label{fig:subch_initial_model} Initial model for the double detonation test problem.}
\end{figure}

An initial perturbation is placed on the symmetry axis of the form:


We do a suite of runs with both Strang and the simplified-SDC
integration, using CFL numbers of 0.2, 0.4, and 0.8 and reaction
network tolerances of $\atolspec = \rtolspec = 10^{-5}$ and $\atolener
= \rtolener = 10^{-6}$.  We also run two sets with tighter tolerances.
The runs labeled ``mixed\_tols'' have $\atolspec = 10^{-8}$ and the
runs labeled ``tol1.e-6'' have $\atolspec = \rtolspec = 10^{-6}$, with
the other tolerances unchanged.  For the step rejection part of VODE,
we use $f = 4$ and $\eta = 4$.

Figure \ref{fig:subch_strang_cfl08_I} shows the temperature, mean
molecular weight, and nuclear energy generation rate for the strang
CFL = 0.8 simulation ({\tt strang\_subch2\_cfl0.8}).  We see that the
mean molecular weight appears mottled behind the inward propagating
detonation in the white dwarf.  Comparing to the energy generation
rate, we see that region is characterized by large energy releases of
alternating signs checkerboarding thoughout the region.  This is
characteristic of the nucleosynthesis struggling to come into
equilibrium at high temperatures when the reverse rates can be
important.  In Figure~\ref{fig:subch_strang_cfl08_II} we look at some
important mass fractions for the same simulation.  Again we see that
the abundances are not smooth behind the inward detonation.

\begin{figure}
\centering
\plotone{strang_subch2_cfl0_8_state}
\caption{\label{fig:subch_strang_cfl08_I}}
\end{figure}

\begin{figure}
\centering
\plotone{strang_subch2_cfl0_8_mass_fractions}
\caption{\label{fig:subch_strang_cfl08_II}}
\end{figure}

We next look at the simplified-SDC version of this same case, {\tt
  sdc\_subch2\_cfl0.8}.  Figure~\ref{fig:subch_sdc_cfl08_I} shows the
temperature, mean molecular weight, and energy generation rate.
Compared to Figure~\ref{fig:subch_strang_cfl08_I}, we see that the
composition and energy generation rates are smooth, without any of the
checkerboarding that plagued the Strang simulation.  The compositions
plot (figure~\ref{fig:subch_sdc_cfl08_II}) shows the same behavior.
This suggests that the simplified-SDC algorithm has an easier time
attaining the correct equilibrium in these conditions.

\begin{figure}
\centering
\plotone{sdc_subch2_cfl0_8_state}
\caption{\label{fig:subch_sdc_cfl08_I}}
\end{figure}

\begin{figure}
\centering
\plotone{sdc_subch2_cfl0_8_mass_fractions}
\caption{\label{fig:subch_sdc_cfl08_II}}
\end{figure}

We now look at the evolution of the state while burning by storing the
thermodynamic state internal to VODE each substep as it evaluates the
righthand side of the ODE system it is integrating.  We pick a point
on the symmetry axis a few zones behind the inward moving shock and
ran both a Strang and simplified-SDC simulation for a single
coarse-grid timestep.  To ensure that we start off the same, both
simulations were started from a checkpoint file from the
simplified-SDC simulation a few steps before 0.1~s.
Figure~\ref{fig:nonaka_plot} shows the evolution of \isot{Ni}{56} over
a single coarse-grid timestep (4 fine-grid timesteps).  We see that
the Strang solution is much more discontinuous, as the reactions and
advection push the solution in different ways, because the processes
are completely independent of one another.  If an equilibrium state is
important to the nucleosynthesis, the large deviations in the Strang
solution mean that we are evaluating the reaction network with a state
out of equilibrium for much of the integration time. \MarginPar{need to double check the data---why are there points in the vertical part of Strang?}

\begin{figure}
\plotone{sdc_compare}
\caption{\label{fig:nonaka_plot} Evolution of $X(\isotm{Ni}{56})$ over
  4 fine-grid timesteps in a single zone behind the inward propagating
  shock.  The Strang points (blue) show the first $\Delta t/2$ burn
  bring the abundance away from equilibrium, then the advection
  overcorrecting it, and finally the second $\Delta t/2$ bringing it
  back toward the equilibrium.  The two simplified-SDC iterations
  appear much smoother.  For the SDC runs, there are a few points
  evaluated beyond the stop time---VODE can use data from outside the
  integration range to interpolate to the final solution.}
\end{figure}


We next look at how the structure seen in
Figures~\ref{fig:subch_strang_cfl08_I} and \ref{fig:subch_sdc_cfl08_I}
vary with CFL number and network tolerance.  We focus just on the
region behind the inward propagating shock.
Figures~\ref{fig:strang_enuc_summary} and
\ref{fig:strang_abar_summary} show the nuclear energy generation rate
and mean molecular weight for all of the Strang runs.  We see that
changing the CFL number does little to affect the state behind the
shock---it continues to take on the mottled appearance characteristic
of not reaching a proper equilibrium.  For the {\tt mixedtol} case, we
see that the state is greatly improved.  We were unable to run the
{\tt tol1.e-6} case for Strang, as the code aborted with too many
subcycles.  While reducing the tolerances does help, it greatly
increases the cost of the simulation.

\begin{figure}
\plotone{strang_enuc_summary_plot.pdf}
\caption{\label{fig:strang_enuc_summary} Comparison of Strang runs showing
the nuclear energy generation rate behind the inward propagating
shock.}
\end{figure}

\begin{figure}
\plotone{strang_abar_summary_plot.pdf}
\caption{\label{fig:strang_abar_summary} Comparison of Strang runs showing
the mean molecular weight behind the inward propagating
shock.}
\end{figure}

The SDC comparisons are shown in Figures~\ref{fig:sdc_enuc_summary}
and \ref{fig:sdc_abar_summary}.  We see that the state behind the
shock looks great regardless of the CFL or integrator tolerances.

\begin{figure}
\plotone{sdc_enuc_summary_plot.pdf}
\caption{\label{fig:sdc_enuc_summary} Comparison of simplified-SDC runs showing
the nuclear energy generation rate behind the inward propagating
shock.}
\end{figure}

\begin{figure}
\plotone{sdc_abar_summary_plot.pdf}
\caption{\label{fig:sdc_abar_summary} Comparison of simplified-SDC runs showing
the mean molecular weight behind the inward propagating
shock.}
\end{figure}


To quantify this effect, we next looks at the total mass of some key
species.  This is often a desired diagnostic for supernova
calculations, since \isot{Ni}{56} powers the lightcurve.  Table
\ref{table:masses} shows the total mass of \isot{He}{4},
\isot{Si}{28}, and \isot{Ni}{56} for each of the simulations.  For the
Strang runs, there are large variations between the different
simulations while the SDC simulations all agree to within a few
percent.  Further, the Strang run with the tighter tolerances is in
good agreement with the masses found by the SDC runs.  This supports
the ideas described above that all of the SDC runs agree while only
the Strang run with the tighter tolerances is reliable.

\begin{deluxetable}{llll}
\tablecaption{\label{table:masses} Species masses.}
\tablehead{\colhead{simulation} & \colhead{$M_{\isotm{He}{4}}$} & \colhead{$M_{\isotm{Si}{28}}$} & \colhead{$M_{\isotm{Ni}{56}}$}}
\startdata
\multicolumn{4}{c}{Strang runs} \\
\hline
{\tt strang\_subch2\_cfl0.2}           & $6.10\times 10^{31}$ & $6.72\times 10^{31}$ & $5.29\times 10^{31}$ \\
{\tt strang\_subch2\_cfl0.4}           & $5.20\times 10^{31}$ & $6.70\times 10^{31}$ & $6.02\times 10^{31}$ \\
{\tt strang\_subch2\_cfl0.4\_mixedtol} & $3.05\times 10^{31}$ & $7.29\times 10^{31}$ & $7.80\times 10^{31}$ \\
{\tt strang\_subch2\_cfl0.8}           & $4.59\times 10^{31}$ & $6.88\times 10^{31}$ & $6.27\times 10^{31}$ \\
\hline
\multicolumn{4}{c}{SDC runs} \\
\hline
{\tt sdc\_subch2\_cfl0.2}           & $3.35\times 10^{31}$  & $7.26\times 10^{31}$  & $8.27\times 10^{31}$ \\
{\tt sdc\_subch2\_cfl0.4}           & $3.30\times 10^{31}$  & $7.27\times 10^{31}$  & $8.13\times 10^{31}$ \\
{\tt sdc\_subch2\_cfl0.4\_mixedtol} & $3.09\times 10^{31}$  & $7.36\times 10^{31}$  & $8.08\times 10^{31}$ \\
{\tt sdc\_subch2\_cfl0.4\_tol1.e-6} & $3.25\times 10^{31}$  & $7.27\times 10^{31}$  & $8.25\times 10^{31}$ \\
{\tt sdc\_subch2\_cfl0.8}           & $3.18\times 10^{31}$  & $7.34\times 10^{31}$  & $7.83\times 10^{31}$ \\
\enddata
\end{deluxetable}


1-d slices along x=0?


\section{Summary}

We presented a simplified spectral deferred corrections scheme for coupling
hydrodynamics and reactions.  We demonstrated that for a moderate-sized reaction
network, the simplified-SDC method 

We have not focused on performance or load-balancing the reactions in
the tests that we ran, but these limited runs show that the
simplified-SDC method runs as fast (or faster) than the Strang method
for the same tolerances and CFL, despite having to do the advection
twice.  We would expect similar behavior for any simulations that are
dominated by the cost of reactions.  If the results above a robust across
different problems and networks, then this suggests that we can run 
the SDC simulation with larger CFL and/or less strict reaction tolerances,
which would translate into a large performance boost.

This new time-integration method is freely available in \castro, and
we will continue to explore it on other problems.  We are particularly
interested in massive star evolution with this method, where the
vigorous shell burning leading up to core-collapse would be an ideal
application for the simplified-SDC method.  In a follow-on paper, we
will show how to couple this new integration method to a table for
evaluating an NSE distribution in the iron core of a massive star.

Future work is to extend this methodology to MHD.  This is very
straightforward since the simplified-SDC method operates solely on the
thermodynamic state.  We will also explore how to couple radiation
hydrodynamics, where we need to do an implicit update for the
radiation energy.


\acknowledgements \castro\ is freely available at
\url{http://github.com/AMReX-Astro/Castro}.  All of the code and
problem setups used here are available in the git repo.  The work at
Stony Brook was supported by DOE/Office of Nuclear Physics grant
DE-FG02-87ER40317.  This material is based upon work supported by the
U.S. Department of Energy, Office of Science, Office of Advanced
Scientific Computing Research and Office of Nuclear Physics,
Scientific Discovery through Advanced Computing (SciDAC) program under
Award Number DE-SC0017955.  This research was supported by the
Exascale Computing Project (17-SC-20-SC), a collaborative effort of
the U.S. Department of Energy Office of Science and the National
Nuclear Security Administration.

\software{\amrex\ \citep{amrex_joss},
          \castro\ \citep{castro},
          GNU Compiler Collection (\url{https://gcc.gnu.org/}),
          Linux (\url{https://www.kernel.org}),
          matplotlib (\citealt{Hunter:2007},  \url{http://matplotlib.org/})
          NumPy \citep{numpy,numpy2},
          python (\url{https://www.python.org/}), 
          \pynucastro\ \citep{pynucastro},
          SymPy \citep{sympy}
         }



\appendix

\section{Jacobian}

\label{sec:app:jacobian}

To solve the reaction system implicitly, the ODE solver needs the
Jacobian, $\partial \Rb/\partial \Uc^\prime$, where $\Uc^\prime =
(\rho X_k, \rho e)^\intercal$ is the subset of the conserved variables we are
integrating.  We follow the method of \cite{castro_sdc} and factor
this into two pieces,
\begin{equation}
\label{eq:factored_jac}
{\bf J} = \frac{\partial \Rb}{\partial {\bf w }} \frac{\partial {\bf w}}{\partial \Uc^\prime}.
\end{equation}
where the state ${\bf w}$ is chosen to match the set of variables used to evaluate the reaction rates.
Writing this out for two species, $X_\alpha$ and $X_\beta$, we have
\begin{equation}
\Uc^\prime = \left ( \begin{array}{c} \rho X_\alpha \\ \rho X_\beta \\ \rho e \end{array} \right )
\end{equation}
For interfacing with the reaction network, we use
\begin{equation}
{\bf w} = \left ( \begin{array}{c} X_\alpha \\  X_\beta \\ T \end{array} \right )
\end{equation}
Note: even though we are using $T$ here instead of $e$, we still do the overall ODE integration
in terms of $(\rho e)$, consistent with the Strang method described in \cite{strang_rnaas}.
%%  in that
%% we use $e$ instead of $T$ as the independent variable.  If the network gives derivatives in terms
%% of temperature, we can convert as:
%% \begin{equation}
%% \left . \frac{\partial \phi}{\partial T} \right |_\rho =
%%   \left . \frac{\partial \phi}{\partial e} \right |_\rho 
%%   \left . \frac{\partial e}{\partial T} \right |_\rho =
%%   c_v \left . \frac{\partial \phi}{\partial e} \right |_\rho
%% \end{equation}
%% for some quantity $\phi(\rho, T)$.  Here we identified the specific heat
%% at constant volume, $c_v = \partial e/\partial T|_\rho$.

The Jacobian transformation $\partial \Uc^\prime/\partial {\bf w}$ is:
\begin{equation}
\frac{\partial \Uc^\prime}{\partial {\bf w}} = \left (
   \begin{array}{ccc}
       \rho & 0 & 0 \\
       0 & \rho & 0  \\
       \rho  e_{X_\alpha} & \rho e_{X_\beta} & \rho c_v \\
     \end{array}\right)
\end{equation}
where we use the following notation for compactness:
\begin{equation}
e_{X_k} = \dedXd
\end{equation}
and the specific heat at constant volume is
\begin{equation}
c_v = \left . \frac{\partial e}{\partial T} \right |_{\rho, X_k}
\end{equation}
We get the inverse
(computed via SymPy) as:
\begin{equation}
\renewcommand{\arraystretch}{1.5}
\frac{\partial {\bf w}}{\partial \Uc^\prime} = \left (
  \begin{array}{ccc}
   \frac{1}{\rho} & 0 & 0 \\
   0 & \frac{1}{\rho} & 0 \\
    -\frac{e_{X_\alpha}}{\rho c_v} & -\frac{e_{X_\beta}}{\rho c_v} & \frac{1}{\rho c_v} \\
   \end{array}\right)
\renewcommand{\arraystretch}{1}
\end{equation}

The reaction vector is
\begin{equation}
\Rb(\Uc^\prime) = \left (  \begin{array}{c} \rho \omegadot_\alpha \\ \rho \omegadot_\beta \\ \rho \Sdot \end{array} \right )
\end{equation}
We take all the quantities to be functions of $\rho$, $e$, and $X_k$,
but since $\rho$ doesn't change from the reactions (the reactive
source of the continuity equation is zero), it is held constant in
these derivatives.  The Jacobian is computed as $\partial \Rb/\partial
{\bf w}$:
\begin{equation}
\renewcommand{\arraystretch}{1.5}
\frac{\partial \Rb}{\partial {\bf w}} = \left (
  \begin{array}{ccc}
     \rho \frac{\partial \omegadot_\alpha}{\partial X_\alpha} &
     \rho \frac{\partial \omegadot_\alpha}{\partial X_\beta} & 
     \rho \frac{\partial \omegadot_\alpha}{\partial T} \\
      %
     \rho \frac{\partial \omegadot_\beta}{\partial X_\alpha} &
     \rho \frac{\partial \omegadot_\beta}{\partial X_\beta} &
     \rho \frac{\partial \omegadot_\beta}{\partial T} \\
     %
     \rho \frac{\partial \Sdot}{\partial X_\alpha} &
     \rho \frac{\partial \Sdot}{\partial X_\beta} &
     \rho \frac{\partial \Sdot}{\partial T} \\
  \end{array}
  \right )
\renewcommand{\arraystretch}{1}
\end{equation}

The final Jacobian is found by multiplying these two:
\begin{equation}
\renewcommand{\arraystretch}{1.5}
\frac{\partial \Rb}{\partial \Uc^\prime} = \left (
  \begin{array}{ccc}
    \frac{\partial \omegadot_\alpha}{\partial X_\alpha} - \frac{e_{X_\alpha}}{c_v} \frac{\partial \omegadot_\alpha}{\partial T} &
    \frac{\partial \omegadot_\alpha}{\partial X_\beta} - \frac{e_{X_\beta}}{c_v} \frac{\partial \omegadot_\alpha}{\partial T} &
    \frac{1}{c_v} \frac{\partial \omegadot_\alpha}{\partial T} \\
     %
    \frac{\partial \omegadot_\beta}{\partial X_\alpha} - \frac{e_{X_\alpha}}{c_v} \frac{\partial \omegadot_\beta}{\partial T} &
    \frac{\partial \omegadot_\beta}{\partial X_\beta} - \frac{e_{X_\beta}}{c_v} \frac{\partial \omegadot_\beta}{\partial T} &
    \frac{1}{c_v} \frac{\partial \omegadot_\beta}{\partial T} \\
     %
     \frac{\partial \Sdot}{\partial X_\alpha} -  \frac{e_{X_\alpha}}{c_v} \frac{\partial \Sdot}{\partial T} &
     \frac{\partial \Sdot}{\partial X_\beta} -  \frac{e_{X_\beta}}{c_v} \frac{\partial \Sdot}{\partial T} &
     \frac{1}{c_v} \frac{\partial \Sdot}{\partial T} \\
  \end{array}
  \right )
\renewcommand{\arraystretch}{1}
\end{equation}
We note that the form of these entries is the same as one would arrive at if you start with the rates expressed as
$\omega_k(\rho, T(\rho, X_j, e), X_j)$ and recognize that constant $e$ implies that
\begin{equation}
\left . \frac{\partial T}{\partial X_k} \right |_{\rho, e} = - \frac{e_{X_k}}{c_v}
\end{equation}

While VODE can compute the entire Jacobian, ${\bf J}$ numerically via
differencing, we found that does not give reliable results.  Instead,
we compute compute the derivatives with respect to $X_k$ and $T$
one-sided differencing, following the algorithm in \cite{lsode} to
minimize numerical noise.  We then use the equation of state to
compute $e_{X_k}$ and $c_v$ and construct the entries of the final
Jacobian.


%======================================================================
% References
%======================================================================

\bibliographystyle{aasjournal}
\bibliography{ws}

\end{document}
